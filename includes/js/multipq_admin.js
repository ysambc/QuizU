jQuery(document).ready(function(t){!function(){t("#multipq_questions").addClass("parent"),mpqId=t("#mpq_id").val(),frame=null}();var e=function(e,n){controller=e,image=n,mpq_nonce=controller.attr("data-nonce"),command=controller.attr("data-command"),path=controller.closest(".parent").attr("data-path"),parent=controller.closest(".parent").attr("data-question"),option=controller.closest(".parent").attr("data-option"),color=controller.closest(".parent").find(".color_picker").val(),title=controller.closest(".parent").find(".title").val(),content=controller.closest(".parent").find(".mce-edit-area iframe").contents().find("#tinymce").html(),highest=controller.closest(".parent").find(".highest select").val(),options=controller.closest(".parent").find("input.option").map(function(){return val=t(this).val(),linkid=t(this).closest(".parent").find(".link.main option:selected").attr("data-linkid"),linkpath=t(this).closest(".parent").find(".link.main option:selected").attr("data-linkpath"),id=t(this).closest(".parent").attr("data-option"),score=t(this).closest(".parent").find(".score").val(),imgId=t(this).closest(".parent").find(".image_id").val(),imgUrl=t(this).closest(".parent").find(".uploaded_image").attr("src"),essay={},t(this).closest(".parent").find(".essay_answer").each(function(){esId=t(this).attr("data-id"),esVal=t(this).val(),esSco=t(this).closest(".essay").find(".score").val(),esLink=t(this).closest(".essay").find(".link.second option:selected").attr("data-linkid"),esPath=t(this).closest(".essay").find(".link.second option:selected").attr("data-linkpath"),essay[esId]={id:esId,value:esVal,score:esSco,link:{linkid:esLink,linkpath:esPath}}}),arr={value:val,link:{linkid:linkid,linkpath:linkpath},id:id,img:{id:imgId,url:imgUrl},score:score,essay:essay},arr}).get(),isResult=controller.closest(".parent").hasClass("result"),flag=controller.is(":checked"),essayFlag=controller.closest(".parent").find(".essay_question_flag").is(":checked"),multipleFlag=controller.closest(".parent").find(".multiple_choice_flag").is(":checked"),"update_result_criteria_flag"==command&&(flag=controller.val()),scoreMin=parseInt(controller.closest(".parent").find("input.range.min").val()),scoreMax=parseInt(controller.closest(".parent").find("input.range.max").val()),optionImg=controller.attr("data-img"),controller.prop("files")&&0!=controller.prop("files").length?file=controller.prop("files")[0]:image&&(file=image,optionImg=image.id),formData=new FormData,"upload_option_image"==command&&(filename="option_image_"+option,flag=controller.closest(".parent").find(".option_image_flag").val(),t.each(file,function(t,e){formData.append(filename+"["+t+"]",e)}),formData.append("mpq_id",mpqId),formData.append("command",command),"upload_option_image"==command&&(formData.append("path",path),formData.append("option",option),prefix="option"),formData.append("parent",parent),formData.append("flag",flag),formData.append("action","multipq_admin_ajax"),formData.append("_ajax_nonce",mpq_nonce))},n=function(){numberOps=0,counterOps=0,i=0,t("#multipq_questions li.question").each(function(){t(this).find("li.option").each(function(){++counterOps>numberOps&&(numberOps=counterOps)}),counterOps=0}),t("#multipq_questions div.result").each(function(){for(selected=t(this).find(".highest select").val(),t(this).find('.highest select option:not([value="option_e"]):not([value=""])').remove();i<numberOps-1;)selected=="option_"+i?t(this).find('.highest select option[value="option_e"]').before('<option selected value="option_'+i+'">'+mpqObj.option+" "+(i+1)+"</option>"):t(this).find('.highest select option[value="option_e"]').before('<option value="option_'+i+'">'+mpqObj.option+" "+(i+1)+"</option>"),i++;i=0})},o=function(){t("#multipq_questions").find('button, input:not([type="hidden"])').attr("disabled",!0)},a=function(){t("#multipq_questions").find('button, input:not([type="hidden"])').removeAttr("disabled")},s=function(e){"new_question"==command&&controller.closest(".path.parent").find("ul.questions.container").prepend(e),"new_option"==command&&(controller.closest(".question.parent").find("ul.options.container").append(e),n()),"new_essay"==command&&(controller.closest(".parent").find(".essay_options").append(e),controller.closest(".parent").find(".essay_answer").length>1?controller.closest(".parent").find(".essay_options .remove_essay").last().removeClass("hidden"):controller.closest(".parent").find(".essay_options .remove_essay").last().addClass("hidden")),"new_path"==command&&(exists=controller.parent().find("div.path.parent"),0!=exists.length?exists.first().before(e):controller.closest(".parent").find(".admin_divider").before(e),d(),makesort()),questionsList=t("#multipq_questions").find("li.question.parent:first-of-type select:first-of-type").html(),selectBoxes=t("#multipq_questions").find("select.link"),"new_question"!=command&&"new_path"!=command||selectBoxes.each(function(){optionSelectedLinkid=t(this).find("option:selected").attr("data-linkid"),selectParent=t(this).closest(".parent").attr("data-question"),t(this).html(questionsList).find("option").removeClass("hidden"),t(this).find('option[data-linkid="'+selectParent+'"]').addClass("hidden"),t(this).find('option[data-linkid="'+optionSelectedLinkid+'"]').attr("selected","true")}),"new_result"==command&&(controller.before(e),elemId=t(e).find(".wp-editor-area").attr("id"),tinymce.execCommand("mceAddEditor",!1,elemId),elem=t("tinymce_"+elemId+"_ifr").find(".wp-editor-area").contents().find("#tinymce"),tinymce.editors[elemId].onChange.add(function(t,e){"true"==mpqObj.flags.autosave&&("undefined"!=typeof mceEditorCounter&&clearTimeout(mceEditorCounter),mceEditorCounter=setTimeout(function(){jQuery(e.target.iframeElement).contents().find("span[data-mce-style]").each(function(){jQuery(this).attr("style",jQuery(this).attr("data-mce-style"))}),jQuery(e.target.targetElm).closest(".parent.result").find(".controller.update").click()},500))}),t("#multipq_questions").find("select.link").each(function(){t(this).append('<option data-linkpath="'+path+'" data-linkid="'+t(e).find("input.id").val()+'" data-result="true" value="'+t(e).find("input.id").val()+'" data-id="'+option+'">Res: '+t(e).find(".title.result").val()+"</option>")}),n()),"delete_question"!=command&&"delete_option"!=command&&"delete_path"!=command&&"delete_result"!=command||controller.closest(".parent").remove(),"delete_question"!=command&&"delete_option"!=command&&"delete_result"!=command||(toRemoveQ=controller.closest(".parent").attr("data-question"),selectBoxes.each(function(){t(this).find('option[data-linkid="'+toRemoveQ+'"]').remove()})),"delete_path"==command&&(toRemoveP=controller.closest(".parent").attr("data-path"),selectBoxes.each(function(){t(this).find('option[data-linkpath="'+toRemoveP+'"]').remove()})),"delete_option"==command&&n(),"delete_option_image"==command&&(controller.closest(".parent").find(".image").removeClass("uploaded"),controller.closest(".parent").find(".uploaded_image").remove()),"update_path"!=command&&"update_question"!=command&&"update_result"!=command||t("#multipq_questions").find("select.link option").each(function(){"update_path"==command&&t(this).attr("data-linkpath")==path&&""!=t(this).val()&&(pathTit=t(this).html(),t(this).html(title.substring(0,2)+title.slice(-1)+pathTit.substring(pathTit.indexOf(":")))),"update_question"==command&&""!=t(this).val()&&t(this).attr("data-linkid")==parent&&(optionTit=t(this).html(),t(this).html(optionTit.substring(0,optionTit.indexOf(":")+1)+" "+title)),"update_result"==command&&t("#multipq_questions").find("select.link option").each(function(){t(this).attr("data-linkid")==parent&&""!=t(this).val()&&t(this).html("Res: "+title)})})},l=function(){"delete_essay"==command&&(contPar=controller.closest(".question.parent"),controller.closest(".essay").remove(),1==contPar.find(".essay_answer").length&&contPar.find(".remove_essay").addClass("hidden"),"true"==mpqObj.flags.autosave&&contPar.find(".controller.update").click()),"update_question"==command&&(1==essayFlag?(controller.closest(".parent").addClass("essay_type"),controller.closest(".parent").find(".multiple_choice_switch").addClass("hidden")):(controller.closest(".parent").removeClass("essay_type"),controller.closest(".parent").find(".multiple_choice_switch").removeClass("hidden")),1==multipleFlag?controller.closest(".parent").addClass("multiple_choice"):controller.closest(".parent").removeClass("multiple_choice"))},r=function(n){if("click"==n.type?controller=t(this):controller=n,e(controller),"update_question"!=command&&"update_result"!=command||(scoreMin>scoreMax?(command="abort",alert(mpqObj.minimal)):t(".result.parent").each(function(e,n){rangeMin=t(this).find(".range.min").val(),rangeMax=t(this).find(".range.max").val(),parent!=t(this).attr("data-question")&&scoreMin+scoreMax!=0&&rangeMin+rangeMax!=0&&Math.max(scoreMin,rangeMin)<=Math.min(scoreMax,rangeMax)&&(alert(mpqObj.overlap+" "+t(this).find(".title.result").val()),command="abort")})),"true"!=mpqObj.flags.autosave){switch(command){case"new_path":nonSaveElem="li.path";break;case"new_question":nonSaveElem="li.question";break;case"new_option":nonSaveElem="li.option";break;case"new_result":nonSaveElem="li.result";break;case"new_essay":nonSaveElem=".essay_answer";break;default:nonSaveElem=null}nonSaveItemCount=controller.closest(".parent").find(nonSaveElem).length}else nonSaveItemCount=null;"true"!=mpqObj.flags.autosave&&("delete_question"==command||"delete_option"==command||"delete_path"==command||"delete_result"==command)||"delete_essay"==command?(data="",s(data),l()):t.ajax({url:ajaxurl,data:{action:"multipq_admin_ajax",_ajax_nonce:mpq_nonce,mpq_id:mpqId,command:command,parent:parent,option:option,option_img:optionImg,path:path,title:title,content:content,highest:highest,options:options,color:color,flag:flag,essay_flag:essayFlag,multiple_flag:multipleFlag,score_min:scoreMin,score_max:scoreMax,non_save_item_count:nonSaveItemCount},type:"POST",dataType:"html",beforeSend:function(t){o()},success:function(t){s(t)},complete:function(t,e){a(),l()}})};t("#multipq_questions").on("click",".controller:not(.flag)",r);var c=function(e){t.ajax({url:ajaxurl,data:{action:"multipq_admin_ajax",_ajax_nonce:t("#update_quiz_tc").val(),mpq_id:mpqId,command:"update_quiz_tc",title:t("#title").val(),content:e.getContent()},type:"POST",dataType:"html",beforeSend:function(t){o()},success:function(t){},complete:function(t,e){a()}})},d=function(){t("#multipq_questions .color_picker").wpColorPicker({change:function(e,n){"true"==mpqObj.flags.autosave&&("undefined"!=typeof colorPickerCounter&&clearTimeout(colorPickerCounter),controllerA=t(this),colorPickerCounter=setTimeout(function(){controllerB=controllerA.closest(".parent").find(".controller.update_path"),controllerA.closest(".parent").find(".color_picker").attr("value",n.color),r(controllerB)},1e3))}})};d();var p=function(n){event.preventDefault(),controller=n,container=controller.closest(".parent"),addImgLink=container.find(".image_upload"),delImgLink=container.find(".image_delete"),imgContainer=container.find(".image"),imgIdInput=container.find(".image_id"),imgUrlInput=container.find(".image_url"),frame?frame.open():(frame=wp.media({title:mpqObj.mediaTitle,button:{text:mpqObj.mediaText},multiple:!1}),frame.on("select",function(){attachment=frame.state().get("selection").first().toJSON(),imgContainer.addClass("uploaded"),delImgLink.before('<img class="uploaded_image" src="'+attachment.url+'"></img>'),e(controller,attachment),"true"==mpqObj.flags.autosave&&t.ajax({url:ajaxurl,data:formData,type:"POST",dataType:"json",processData:!1,contentType:!1,beforeSend:function(t){o()},success:function(t){},complete:function(t,e){a()}})}),frame.open())};makesort=function(){connected=!1,t("#multipq_questions .questions").sortable({connectWith:".path .questions.container",handle:".sort_handle",receive:function(e,n){new_path=n.item.closest(".path.parent").attr("data-path"),prev_path=n.sender.attr("data-path"),prev_quest=n.item.attr("data-id"),pathDad=n.item.closest(".parent.path"),pathTit=pathDad.find("> wraper > .title.path").val(),n.item.find("input").each(function(){t(this).attr("name",t(this).attr("name").replace(prev_path,new_path)),t("#multipq_questions").each(function(){t(this).attr("data-linkid")==n.item.attr("data-id")&&(t(this).attr("data-linkpath",new_path),t(this).html(pathTit+t(this).html().substring(t(this).html().indexOf(":"))))})}),connected=!0},stop:function(e,n){mpq_nonce=n.item.attr("data-sort"),command="sort_questions",new_order={},n.item.closest(".path.parent").find(".parent.question").each(function(){new_order[t(this).attr("data-question")]=""}),toSend={action:"multipq_admin_ajax",_ajax_nonce:mpq_nonce,mpq_id:mpqId,command:command,new_order:new_order},1==connected?(connectedToSend={prev_quest:prev_quest,new_path:new_path,prev_path:prev_path,connected:connected},Object.keys(connectedToSend).forEach(function(t){toSend[t]=connectedToSend[t]})):(new_path=n.item.closest(".parent").attr("data-path"),toSend.new_path=new_path),n.item.attr("data-path",new_path),"true"==mpqObj.flags.autosave&&t.ajax({url:ajaxurl,data:toSend,type:"POST",dataType:"html",beforeSend:function(t){o()},success:function(t){},complete:function(t,e){a()}})}})},makesort(),"true"==mpqObj.flags.autosave?(t("#multipq_questions").on("click",".controller.flag",function(){r(t(this))}),t("#multipq_questions").on("change keydown","input.title, .essay input, input.score, input.range, .wp-editor-area",function(e){13!=e.keyCode&&"change"!=e.type||(13==e.keyCode&&event.preventDefault(),(t(this).hasClass("score")||t(this).hasClass("range"))&&isNaN(t(this).val())?alert(mpqObj.integer):t(this).closest(".parent:not(.option)").find(".controller.update").click())}),t("#multipq_questions").on("change","select.link",function(){t(this).closest(".parent.question").find(".controller.update").click()}),t("#multipq_questions").on("change",".highest select",function(){t(this).closest(".parent.result").find(".controller.update").click()}),t("#multipq_questions #postdivrich").on("change",".wp-editor-area",function(){t("#publish").find(".controller.update").click()}),"undefined"!=typeof tinymce&&tinymce.on("SetupEditor",function(t){"content"===t.id&&t.on("change keyup paste",function(e){"undefined"!=typeof mceEditorCounter&&clearTimeout(mceEditorCounter),mceEditorCounter=setTimeout(function(){jQuery(t.target.iframeElement).contents().find("span[data-mce-style]").each(function(){jQuery(this).attr("style",jQuery(this).attr("data-mce-style"))}),c(t)},500)})}),t("#titlewrap").on("change","#title",function(){wp.autosave.server&&c(tinymce.editors.content)})):t("#multipq_questions").on("click",".controller.flag",function(){"update_question"==t(this).attr("data-command")&&(1==t(this).is(":checked")?t(this).closest(".parent").addClass("essay_type"):t(this).closest(".parent").removeClass("essay_type"))}),t("#multipq_questions").on("change","#results_criteria",function(){switch(t(this).attr("data-flag",t(this).val()),t(this).val()){case"results_by_total":t("#multipq_questions select.link").addClass("results_by_score"),t("#multipq_questions div.result .buttons").addClass("results_by_total"),t("#multipq_questions div.result .buttons").removeClass("results_by_option");break;case"results_by_option":t("#multipq_questions select.link").addClass("results_by_score"),t("#multipq_questions div.result .buttons").addClass("results_by_option"),t("#multipq_questions div.result .buttons").removeClass("results_by_total"),n();break;case"results_by_path":t("#multipq_questions select.link").removeClass("results_by_score"),t("#multipq_questions div.result .buttons").addClass("results_by_total"),t("#multipq_questions div.result .buttons").removeClass("results_by_option")}"true"==mpqObj.flags.autosave&&r(t(this))}),t("#multipq_questions").on("click",".collapse",function(){t(this).closest(".parent").find("ul.container").toggleClass("collapsed")}),t("#multipq_questions").on("click",".image.upload",function(){p(t(this))})});